<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情绪识别管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 400px;
            width: 100%;
        }

        .login-card h2 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .main-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: #2d3748;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .sidebar h3 {
            margin-bottom: 30px;
            font-weight: 600;
            color: #667eea;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            color: #cbd5e0;
            padding: 12px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-link:hover, .nav-link.active {
            background: #4a5568;
            color: white;
            text-decoration: none;
        }

        .content {
            flex: 1;
            padding: 20px;
            background: #f7fafc;
            overflow-y: auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h2 {
            margin: 0;
            color: #2d3748;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #2d3748;
        }

        .card-body {
            padding: 20px;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .stat-content h4 {
            margin: 0;
            font-size: 14px;
            color: #718096;
            font-weight: 500;
        }

        .stat-content p {
            margin: 5px 0 0 0;
            font-size: 28px;
            font-weight: 600;
            color: #2d3748;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .video-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .video-header {
            padding: 15px;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-header h5 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .video-content {
            padding: 15px;
        }

        .video-preview {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .video-preview video {
            width: 100%;
            border-radius: 8px;
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        .emotion-result {
            text-align: center;
            padding: 10px;
            background: #f0f4f8;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .emotion-label {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .emotion-confidence {
            font-size: 14px;
            color: #718096;
        }

        .config-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .config-section h4 {
            margin-bottom: 20px;
            font-weight: 600;
            color: #2d3748;
        }

        .config-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .config-item {
            flex: 1;
            min-width: 200px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .data-table {
            margin-top: 20px;
        }

        .data-table th {
            background: #f7fafc;
            font-weight: 600;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .alert {
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 15px;
            }

            .video-grid {
                grid-template-columns: 1fr;
            }

            .config-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 登录界面 -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <h2><i class="fa fa-smile-o"></i> 情绪识别管理系统</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">用户名</label>
                    <input type="text" class="form-control" id="username" placeholder="请输入用户名" required>
                </div>
                <div class="form-group">
                    <label for="password">密码</label>
                    <input type="password" class="form-control" id="password" placeholder="请输入密码" required>
                </div>
                <div class="form-group form-check">
                    <input type="checkbox" class="form-check-input" id="remember">
                    <label class="form-check-label" for="remember">记住密码</label>
                </div>
                <button type="submit" class="btn btn-primary btn-block">登录</button>
                <div class="text-center mt-3">
                    <a href="#" class="text-muted">忘记密码?</a>
                </div>
            </form>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="appContainer" class="main-container" style="display: none;">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <h3><i class="fa fa-smile-o"></i> 情绪识别系统</h3>
            <nav>
                <div class="nav-item">
                    <a href="#" class="nav-link active" data-page="dashboard">
                        <i class="fa fa-dashboard"></i>
                        <span>控制台</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="detection">
                        <i class="fa fa-video-camera"></i>
                        <span>实时检测</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="history">
                        <i class="fa fa-history"></i>
                        <span>历史记录</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="reports">
                        <i class="fa fa-bar-chart"></i>
                        <span>统计报表</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="configuration">
                        <i class="fa fa-cog"></i>
                        <span>系统配置</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="device">
                        <i class="fa fa-server"></i>
                        <span>设备管理</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="alerts">
                        <i class="fa fa-bell"></i>
                        <span>告警管理</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="logs">
                        <i class="fa fa-file-text-o"></i>
                        <span>日志管理</span>
                    </a>
                </div>
            </nav>
            <div class="mt-auto">
                <hr style="border-color: #4a5568;">
                <button id="logoutBtn" class="btn btn-danger btn-block">
                    <i class="fa fa-sign-out"></i> 退出登录
                </button>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="content">
            <!-- 页面头部 -->
            <div class="header">
                <h2 id="pageTitle">控制台</h2>
                <div class="user-info">
                    <span id="currentUser">管理员</span>
                    <i class="fa fa-user-circle" style="font-size: 24px; color: #667eea;"></i>
                </div>
            </div>

            <!-- 控制台页面 -->
            <div id="dashboardPage" class="page-content">
                <!-- 统计卡片 -->
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fa fa-video-camera"></i>
                        </div>
                        <div class="stat-content">
                            <h4>在线设备</h4>
                            <p id="onlineDevices">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fa fa-smile-o"></i>
                        </div>
                        <div class="stat-content">
                            <h4>今日识别次数</h4>
                            <p id="todayRecognition">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fa fa-bell"></i>
                        </div>
                        <div class="stat-content">
                            <h4>今日告警数</h4>
                            <p id="todayAlerts">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fa fa-line-chart"></i>
                        </div>
                        <div class="stat-content">
                            <h4>识别准确率</h4>
                            <p id="accuracy">0%</p>
                        </div>
                    </div>
                </div>

                <!-- 实时监控 -->
                <div class="card">
                    <div class="card-header">
                        <h4>实时监控</h4>
                    </div>
                    <div class="card-body">
                        <div class="video-grid">
                            <div class="video-card">
                                <div class="video-header">
                                    <h5>摄像头 1</h5>
                                    <span class="badge bg-success">在线</span>
                                </div>
                                <div class="video-content">
                                    <div class="video-preview">
                                        <video autoplay muted playsinline></video>
                                        <div class="video-overlay">实时检测</div>
                                    </div>
                                    <div class="emotion-result">
                                        <div class="emotion-label">中性</div>
                                        <div class="emotion-confidence">置信度: 85.2%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 情绪分布 -->
                <div class="card">
                    <div class="card-header">
                        <h4>今日情绪分布</h4>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="emotionDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 实时检测页面 -->
            <div id="detectionPage" class="page-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4>实时情绪检测</h4>
                            <div>
                                <button class="btn btn-primary btn-sm mr-2" id="startDetection">
                                    <i class="fa fa-play"></i> 开始检测
                                </button>
                                <button class="btn btn-danger btn-sm" id="stopDetection">
                                    <i class="fa fa-stop"></i> 停止检测
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="video-grid">
                                    <div class="video-card">
                                        <div class="video-header">
                                            <h5>摄像头 1</h5>
                                            <select class="form-control form-control-sm">
                                                <option>USB摄像头</option>
                                                <option>网络摄像头</option>
                                            </select>
                                        </div>
                                        <div class="video-content">
                                            <div class="video-preview">
                                                <video id="detectionVideo" autoplay muted playsinline style="width: 100%;"></video>
                                                <canvas id="detectionCanvas" style="position: absolute; top: 0; left: 0;"></canvas>
                                            </div>
                                            <div class="emotion-result">
                                                <div class="emotion-label" id="currentEmotion">未检测到人脸</div>
                                                <div class="emotion-confidence" id="emotionConfidence">置信度: -</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <!-- 环形情感模型 -->
                                    <div class="col-12 mb-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>环形情感模型 (效价-唤醒度)</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="chart-container" style="height: 250px;">
                                                    <canvas id="circumplexChart"></canvas>
                                                </div>
                                                <div class="mt-2">
                                                    <div>效价: <span id="valenceValue">-</span></div>
                                                    <div>唤醒度: <span id="arousalValue">-</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 三维情感模型 -->
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>三维情感模型 (愉悦度-强度-关注度)</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="chart-container" style="height: 250px;">
                                                    <canvas id="dimension3dChart"></canvas>
                                                </div>
                                                <div class="mt-2">
                                                    <div>愉悦度: <span id="pleasureValue">-</span></div>
                                                    <div>强度: <span id="intensityValue">-</span></div>
                                                    <div>关注度: <span id="attentionValue">-</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 情绪趋势 -->
                <div class="card">
                    <div class="card-header">
                        <h4>情绪变化趋势</h4>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="emotionTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 历史记录页面 -->
            <div id="historyPage" class="page-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4>历史识别记录</h4>
                            <div class="input-group" style="width: 300px;">
                                <input type="text" class="form-control" placeholder="搜索记录...">
                                <div class="input-group-append">
                                    <button class="btn btn-primary">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered table-hover data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>设备</th>
                                    <th>时间</th>
                                    <th>情绪</th>
                                    <th>置信度</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- 历史记录将通过JavaScript动态添加 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 统计报表页面 -->
            <div id="reportsPage" class="page-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h4>情绪统计报表</h4>
                    </div>
                    <div class="card-body">
                        <div class="config-section">
                            <h4>报表配置</h4>
                            <div class="config-row">
                                <div class="config-item">
                                    <label for="reportType">报表类型</label>
                                    <select class="form-control" id="reportType">
                                        <option>日报表</option>
                                        <option>周报表</option>
                                        <option>月报表</option>
                                        <option>年报表</option>
                                    </select>
                                </div>
                                <div class="config-item">
                                    <label for="startDate">开始日期</label>
                                    <input type="date" class="form-control" id="startDate">
                                </div>
                                <div class="config-item">
                                    <label for="endDate">结束日期</label>
                                    <input type="date" class="form-control" id="endDate">
                                </div>
                                <div class="config-item">
                                    <label for="reportDevice">设备</label>
                                    <select class="form-control" id="reportDevice">
                                        <option>所有设备</option>
                                        <option>设备 1</option>
                                        <option>设备 2</option>
                                    </select>
                                </div>
                                <div class="config-item" style="display: flex; align-items: flex-end;">
                                    <button class="btn btn-primary" style="width: 100%;">生成报表</button>
                                </div>
                            </div>
                        </div>

                        <div class="chart-container">
                            <canvas id="reportChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 系统配置页面 -->
            <div id="configurationPage" class="page-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h4>系统配置</h4>
                    </div>
                    <div class="card-body">
                        <div class="config-section">
                            <h4>视频采集配置</h4>
                            <div class="config-row">
                                <div class="config-item">
                                    <label for="resolution">分辨率</label>
                                    <select class="form-control" id="resolution">
                                        <option>640x480</option>
                                        <option>1280x720</option>
                                        <option>1920x1080</option>
                                    </select>
                                </div>
                                <div class="config-item">
                                    <label for="frameRate">帧率</label>
                                    <select class="form-control" id="frameRate">
                                        <option>15</option>
                                        <option>25</option>
                                        <option>30</option>
                                    </select>
                                </div>
                                <div class="config-item">
                                    <label for="videoFormat">视频格式</label>
                                    <select class="form-control" id="videoFormat">
                                        <option>MP4</option>
                                        <option>AVI</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="config-section">
                            <h4>识别参数配置</h4>
                            <div class="config-row">
                                <div class="config-item">
                                    <label for="emotionModel">情绪模型</label>
                                    <select class="form-control" id="emotionModel">
                                        <option value="discrete">离散情绪模型</option>
                                        <option value="circumplex">环形情感模型</option>
                                        <option value="3d">三维情感模型</option>
                                    </select>
                                </div>
                                <div class="config-item">
                                    <label for="confidenceThreshold">置信度阈值</label>
                                    <input type="number" class="form-control" id="confidenceThreshold" value="0.85" min="0" max="1" step="0.01">
                                </div>
                                <div class="config-item">
                                    <label for="detectionInterval">检测间隔(ms)</label>
                                    <input type="number" class="form-control" id="detectionInterval" value="100" min="50" max="1000" step="50">
                                </div>
                            </div>
                            <div class="config-row">
                                <div class="config-item">
                                    <label for="emotionChangeThreshold">情绪突变阈值</label>
                                    <input type="number" class="form-control" id="emotionChangeThreshold" value="0.3" min="0" max="2" step="0.1">
                                </div>
                                <div class="config-item">
                                    <label for="maxHistoryLength">最大历史记录长度</label>
                                    <input type="number" class="form-control" id="maxHistoryLength" value="1000" min="100" max="10000" step="100">
                                </div>
                            </div>
                        </div>

                        <div class="config-section">
                            <h4>图像增强配置</h4>
                            <div class="config-row">
                                <div class="config-item">
                                    <label for="brightness">亮度调整</label>
                                    <input type="number" class="form-control" id="brightness" value="1.0" min="0.5" max="2.0" step="0.1">
                                </div>
                                <div class="config-item">
                                    <label for="contrast">对比度调整</label>
                                    <input type="number" class="form-control" id="contrast" value="1.2" min="0.5" max="2.0" step="0.1">
                                </div>
                                <div class="config-item">
                                    <label for="noiseReduction">噪声去除</label>
                                    <select class="form-control" id="noiseReduction">
                                        <option value="0">无</option>
                                        <option value="1">弱</option>
                                        <option value="2" selected>中</option>
                                        <option value="3">强</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="config-section">
                            <h4>模型管理</h4>
                            <div class="config-row">
                                <div class="config-item" style="flex: 2;">
                                    <label for="modelPath">模型路径</label>
                                    <input type="text" class="form-control" id="modelPath" value="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/">
                                </div>
                                <div class="config-item" style="display: flex; align-items: flex-end;">
                                    <button class="btn btn-primary" id="testModelConnection">测试连接</button>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-warning mr-2" id="updateModel">更新模型</button>
                                <button class="btn btn-info" id="customModel">上传自定义模型</button>
                            </div>
                            <div id="modelStatus" class="mt-2" style="color: green;"></div>
                        </div>

                        <div class="config-section">
                            <h4>存储配置</h4>
                            <div class="config-row">
                                <div class="config-item">
                                    <label for="storagePath">存储路径</label>
                                    <input type="text" class="form-control" id="storagePath" value="/data/emotion">
                                </div>
                                <div class="config-item">
                                    <label for="storagePeriod">存储周期(天)</label>
                                    <input type="number" class="form-control" id="storagePeriod" value="30" min="7" max="365">
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button class="btn btn-primary mr-2">保存配置</button>
                            <button class="btn btn-secondary">重置</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 设备管理页面 -->
            <div id="devicePage" class="page-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4>设备管理</h4>
                            <button class="btn btn-primary">
                                <i class="fa fa-plus"></i> 添加设备
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered table-hover data-table">
                            <thead>
                                <tr>
                                    <th>设备ID</th>
                                    <th>设备名称</th>
                                    <th>设备类型</th>
                                    <th>IP地址</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="deviceTableBody">
                                <!-- 设备列表将通过JavaScript动态添加 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 告警管理页面 -->
            <div id="alertsPage" class="page-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h4>告警管理</h4>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered table-hover data-table">
                            <thead>
                                <tr>
                                    <th>告警ID</th>
                                    <th>设备</th>
                                    <th>告警类型</th>
                                    <th>告警时间</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="alertsTableBody">
                                <!-- 告警列表将通过JavaScript动态添加 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 日志管理页面 -->
            <div id="logsPage" class="page-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4>日志管理</h4>
                            <button class="btn btn-primary btn-sm">
                                <i class="fa fa-download"></i> 导出日志
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered table-hover data-table">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>日志类型</th>
                                    <th>操作人</th>
                                    <th>内容</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                                <!-- 日志列表将通过JavaScript动态添加 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 引入face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <script>
        // 系统状态
        let currentUser = null;
        let isDetectionRunning = false;
        let detectionInterval;
        let videoStream;
        
        // 角色定义
        const roles = {
            admin: {
                name: '管理员',
                permissions: ['view', 'manage_devices', 'manage_config', 'manage_users', 'manage_alerts', 'export_data']
            },
            operator: {
                name: '操作员',
                permissions: ['view', 'manage_alerts', 'export_data']
            },
            viewer: {
                name: '查看员',
                permissions: ['view']
            }
        };
        
        // 用户列表
        let users = [
            {
                id: 1,
                username: 'admin',
                password: 'admin123',
                role: 'admin',
                name: '系统管理员',
                email: 'admin@example.com',
                status: 'active'
            },
            {
                id: 2,
                username: 'operator',
                password: 'operator123',
                role: 'operator',
                name: '操作员',
                email: 'operator@example.com',
                status: 'active'
            },
            {
                id: 3,
                username: 'viewer',
                password: 'viewer123',
                role: 'viewer',
                name: '查看员',
                email: 'viewer@example.com',
                status: 'active'
            }
        ];
        
        // 系统配置
        let systemConfig = {
            emotionModel: 'discrete',
            confidenceThreshold: 0.85,
            detectionInterval: 100,
            brightness: 1.0,
            contrast: 1.2,
            noiseReduction: 1,
            modelPath: 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/',
            resolution: '1280x720',
            frameRate: 30,
            videoFormat: 'MP4',
            storagePath: '/data/emotion',
            storagePeriod: 30,
            emotionChangeThreshold: 0.3, // 情绪突变阈值
            maxHistoryLength: 1000 // 最大历史记录长度
        };
        
        // 情绪数据
        const emotions = ['neutral', 'happy', 'sad', 'angry', 'fearful', 'disgusted', 'surprised'];
        const emotionNames = {
            'neutral': '中性',
            'happy': '开心',
            'sad': '悲伤',
            'angry': '愤怒',
            'fearful': '恐惧',
            'disgusted': '厌恶',
            'surprised': '惊讶'
        };
        
        // 模型类型映射
        const emotionModels = {
            'discrete': '离散情绪模型',
            'circumplex': '环形情感模型',
            '3d': '三维情感模型'
        };
        
        // 历史情绪数据
        let emotionHistory = [];
        
        // 情绪事件记录
        let emotionEvents = [];
        
        // 表情到效价-唤醒度空间的映射
        const expressionCoordinates = {
            'neutral': { valence: 0, arousal: 0 },
            'happy': { valence: 0.8, arousal: 0.7 },
            'sad': { valence: -0.6, arousal: -0.4 },
            'angry': { valence: -0.7, arousal: 0.6 },
            'fearful': { valence: -0.5, arousal: 0.8 },
            'disgusted': { valence: -0.8, arousal: 0.3 },
            'surprised': { valence: 0.5, arousal: 0.9 }
        };
        
        // 表情到三维情感空间的映射
        const expression3DCoordinates = {
            'neutral': { pleasure: 0, intensity: 0, attention: 0 },
            'happy': { pleasure: 0.9, intensity: 0.7, attention: 0.6 },
            'sad': { pleasure: -0.7, intensity: 0.4, attention: 0.3 },
            'angry': { pleasure: -0.8, intensity: 0.9, attention: 0.8 },
            'fearful': { pleasure: -0.6, intensity: 0.8, attention: 0.9 },
            'disgusted': { pleasure: -0.9, intensity: 0.5, attention: 0.4 },
            'surprised': { pleasure: 0.6, intensity: 0.8, attention: 0.9 }
        };
        
        // 初始化应用
        function initApp() {
            // 初始化登录功能
            initLogin();
            
            // 初始化导航功能
            initNavigation();
            
            // 初始化图表
            initCharts();
            
            // 初始化实时检测功能
            initRealTimeDetection();
            
            // 初始化配置功能
            initConfiguration();
            
            // 模拟数据
            loadMockData();
        }
        
        // 初始化配置功能
        function initConfiguration() {
            // 加载配置到界面
            loadConfigToUI();
            
            // 绑定配置保存事件
            document.querySelector('#configurationPage .btn-primary').addEventListener('click', saveConfig);
            
            // 绑定重置按钮事件
            document.querySelector('#configurationPage .btn-secondary').addEventListener('click', resetConfig);
            
            // 绑定模型管理事件
            document.getElementById('testModelConnection').addEventListener('click', testModelConnection);
            document.getElementById('updateModel').addEventListener('click', updateModel);
            document.getElementById('customModel').addEventListener('click', uploadCustomModel);
        }
        
        // 加载配置到界面
        function loadConfigToUI() {
            document.getElementById('emotionModel').value = systemConfig.emotionModel;
            document.getElementById('confidenceThreshold').value = systemConfig.confidenceThreshold;
            document.getElementById('detectionInterval').value = systemConfig.detectionInterval;
            document.getElementById('brightness').value = systemConfig.brightness;
            document.getElementById('contrast').value = systemConfig.contrast;
            document.getElementById('noiseReduction').value = systemConfig.noiseReduction;
            document.getElementById('modelPath').value = systemConfig.modelPath;
            document.getElementById('resolution').value = systemConfig.resolution;
            document.getElementById('frameRate').value = systemConfig.frameRate;
            document.getElementById('videoFormat').value = systemConfig.videoFormat;
            document.getElementById('storagePath').value = systemConfig.storagePath;
            document.getElementById('storagePeriod').value = systemConfig.storagePeriod;
        }
        
        // 从界面获取配置
        function getConfigFromUI() {
            return {
                emotionModel: document.getElementById('emotionModel').value,
                confidenceThreshold: parseFloat(document.getElementById('confidenceThreshold').value),
                detectionInterval: parseInt(document.getElementById('detectionInterval').value),
                emotionChangeThreshold: parseFloat(document.getElementById('emotionChangeThreshold').value),
                maxHistoryLength: parseInt(document.getElementById('maxHistoryLength').value),
                brightness: parseFloat(document.getElementById('brightness').value),
                contrast: parseFloat(document.getElementById('contrast').value),
                noiseReduction: parseInt(document.getElementById('noiseReduction').value),
                modelPath: document.getElementById('modelPath').value,
                resolution: document.getElementById('resolution').value,
                frameRate: parseInt(document.getElementById('frameRate').value),
                videoFormat: document.getElementById('videoFormat').value,
                storagePath: document.getElementById('storagePath').value,
                storagePeriod: parseInt(document.getElementById('storagePeriod').value)
            };
        }
        
        // 保存配置
        function saveConfig() {
            const newConfig = getConfigFromUI();
            systemConfig = {...systemConfig, ...newConfig};
            
            // 保存到本地存储
            localStorage.setItem('emotionDetectionConfig', JSON.stringify(systemConfig));
            
            // 更新检测间隔
            if (isDetectionRunning) {
                clearInterval(detectionInterval);
                const video = document.querySelector('#detectionVideo');
                const canvas = document.getElementById('detectionCanvas');
                detectionInterval = setInterval(() => {
                    if (isDetectionRunning) {
                        startDetectionLoop(video, canvas);
                    }
                }, systemConfig.detectionInterval);
            }
            
            alert('配置已保存');
        }
        
        // 重置配置
        function resetConfig() {
            // 重置为默认配置
            systemConfig = {
                emotionModel: 'discrete',
                confidenceThreshold: 0.85,
                detectionInterval: 100,
                emotionChangeThreshold: 0.3,
                maxHistoryLength: 1000,
                brightness: 1.0,
                contrast: 1.2,
                noiseReduction: 1,
                modelPath: 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/',
                resolution: '1280x720',
                frameRate: 30,
                videoFormat: 'MP4',
                storagePath: '/data/emotion',
                storagePeriod: 30
            };
            
            loadConfigToUI();
        }
        
        // 测试模型连接
        async function testModelConnection() {
            const modelPath = document.getElementById('modelPath').value;
            const modelStatus = document.getElementById('modelStatus');
            
            modelStatus.textContent = '正在测试模型连接...';
            modelStatus.style.color = 'orange';
            
            try {
                // 尝试加载一个简单的模型来测试连接
                await faceapi.nets.tinyFaceDetector.loadFromUri(modelPath);
                modelStatus.textContent = '模型连接成功！';
                modelStatus.style.color = 'green';
            } catch (error) {
                console.error('模型连接测试失败:', error);
                modelStatus.textContent = `连接失败: ${error.message}`;
                modelStatus.style.color = 'red';
            }
        }
        
        // 更新模型
        async function updateModel() {
            const modelPath = document.getElementById('modelPath').value;
            const modelStatus = document.getElementById('modelStatus');
            
            modelStatus.textContent = '正在更新模型...';
            modelStatus.style.color = 'orange';
            
            try {
                // 重新加载所有模型
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(modelPath),
                    faceapi.nets.faceExpressionNet.loadFromUri(modelPath)
                ]);
                modelStatus.textContent = '模型更新成功！';
                modelStatus.style.color = 'green';
            } catch (error) {
                console.error('模型更新失败:', error);
                modelStatus.textContent = `更新失败: ${error.message}`;
                modelStatus.style.color = 'red';
            }
        }
        
        // 上传自定义模型
        function uploadCustomModel() {
            // 这里可以实现上传自定义模型的逻辑
            alert('上传自定义模型功能正在开发中...');
            // 实际实现中可以添加文件上传组件
        }
        
        // 初始化登录功能
        function initLogin() {
            const loginForm = document.getElementById('loginForm');
            
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                // 用户验证
                const user = users.find(u => u.username === username && u.password === password && u.status === 'active');
                
                if (user) {
                    currentUser = user;
                    document.getElementById('currentUser').textContent = user.name;
                    
                    // 显示主应用
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'flex';
                    
                    // 加载系统数据
                    loadSystemData();
                    
                    // 应用权限控制
                    applyPermissionControl();
                    
                    // 加载用户管理界面
                    loadUserManagement();
                } else {
                    alert('用户名或密码错误，或账号已禁用');
                }
            });
        }
        
        // 应用权限控制
        function applyPermissionControl() {
            if (!currentUser) return;
            
            const role = roles[currentUser.role];
            if (!role) return;
            
            // 根据权限控制导航菜单
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                const page = link.getAttribute('data-page');
                
                // 检查权限
                let hasPermission = true;
                
                if (page === 'configuration' || page === 'device') {
                    hasPermission = role.permissions.includes('manage_config');
                } else if (page === 'alerts') {
                    hasPermission = role.permissions.includes('manage_alerts');
                }
                
                if (hasPermission) {
                    link.style.display = 'flex';
                } else {
                    link.style.display = 'none';
                }
            });
        }
        
        // 加载用户管理界面
        function loadUserManagement() {
            // 只有管理员可以管理用户
            if (currentUser.role !== 'admin') return;
            
            // 创建用户管理页面
            const usersPage = `
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4>用户管理</h4>
                            <button class="btn btn-primary" id="addUserBtn">
                                <i class="fa fa-plus"></i> 添加用户
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered table-hover data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>用户名</th>
                                    <th>姓名</th>
                                    <th>角色</th>
                                    <th>邮箱</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- 用户列表将通过JavaScript动态添加 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // 添加用户管理页面到侧边栏
            const sidebar = document.querySelector('.sidebar nav');
            const userNavItem = `
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="users">
                        <i class="fa fa-users"></i>
                        <span>用户管理</span>
                    </a>
                </div>
            `;
            sidebar.innerHTML += userNavItem;
            
            // 添加用户管理页面内容
            const mainContent = document.querySelector('.content');
            const usersPageElement = document.createElement('div');
            usersPageElement.id = 'usersPage';
            usersPageElement.className = 'page-content';
            usersPageElement.style.display = 'none';
            usersPageElement.innerHTML = usersPage;
            mainContent.appendChild(usersPageElement);
            
            // 更新导航逻辑
            initNavigation();
            
            // 加载用户列表
            loadUsersTable();
            
            // 绑定用户管理事件
            document.getElementById('addUserBtn').addEventListener('click', addUser);
        }
        
        // 加载用户列表
        function loadUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                const statusBadge = user.status === 'active' ? 
                    '<span class="badge bg-success">激活</span>' : 
                    '<span class="badge bg-danger">禁用</span>';
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.name}</td>
                    <td>${roles[user.role].name}</td>
                    <td>${user.email}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm mr-1" onclick="editUser(${user.id})">编辑</button>
                        <button class="btn btn-danger btn-sm mr-1" onclick="deleteUser(${user.id})">删除</button>
                        <button class="btn btn-warning btn-sm" onclick="toggleUserStatus(${user.id})">
                            ${user.status === 'active' ? '禁用' : '激活'}
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // 添加用户
        function addUser() {
            // 简单的添加用户逻辑，实际应用中应使用模态框
            const username = prompt('请输入用户名:');
            const password = prompt('请输入密码:');
            const name = prompt('请输入姓名:');
            const email = prompt('请输入邮箱:');
            const role = prompt('请输入角色 (admin/operator/viewer):');
            
            if (username && password && name && email && roles[role]) {
                const newUser = {
                    id: users.length + 1,
                    username,
                    password,
                    name,
                    email,
                    role,
                    status: 'active'
                };
                
                users.push(newUser);
                loadUsersTable();
            } else {
                alert('输入信息有误，请重试');
            }
        }
        
        // 编辑用户
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const name = prompt('请输入新姓名:', user.name);
            const email = prompt('请输入新邮箱:', user.email);
            const role = prompt('请输入新角色 (admin/operator/viewer):', user.role);
            
            if (name && email && roles[role]) {
                user.name = name;
                user.email = email;
                user.role = role;
                loadUsersTable();
            } else {
                alert('输入信息有误，请重试');
            }
        }
        
        // 删除用户
        function deleteUser(userId) {
            if (userId === 1) {
                alert('不能删除系统管理员账号');
                return;
            }
            
            if (confirm('确定要删除该用户吗？')) {
                users = users.filter(u => u.id !== userId);
                loadUsersTable();
            }
        }
        
        // 切换用户状态
        function toggleUserStatus(userId) {
            if (userId === 1) {
                alert('不能禁用系统管理员账号');
                return;
            }
            
            const user = users.find(u => u.id === userId);
            if (user) {
                user.status = user.status === 'active' ? 'inactive' : 'active';
                loadUsersTable();
            }
        }
        
        // 初始化导航功能
        function initNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pageContents = document.querySelectorAll('.page-content');
            const pageTitle = document.getElementById('pageTitle');
            
            const pageTitles = {
                'dashboard': '控制台',
                'detection': '实时检测',
                'history': '历史记录',
                'reports': '统计报表',
                'configuration': '系统配置',
                'device': '设备管理',
                'alerts': '告警管理',
                'logs': '日志管理'
            };
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // 移除所有激活状态
                    navLinks.forEach(l => l.classList.remove('active'));
                    pageContents.forEach(p => p.style.display = 'none');
                    
                    // 添加当前激活状态
                    link.classList.add('active');
                    const pageId = link.getAttribute('data-page');
                    document.getElementById(`${pageId}Page`).style.display = 'block';
                    pageTitle.textContent = pageTitles[pageId];
                });
            });
        }
        
        // 图表实例
        let circumplexChart = null;
        let dimension3dChart = null;
        
        // 初始化图表
        function initCharts() {
            // 情绪分布图表
            const emotionCtx = document.getElementById('emotionDistributionChart').getContext('2d');
            new Chart(emotionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['开心', '悲伤', '愤怒', '恐惧', '惊讶', '中性'],
                    datasets: [{
                        data: [30, 15, 10, 5, 20, 20],
                        backgroundColor: [
                            '#4CAF50', '#2196F3', '#FF9800', '#F44336', '#9C27B0', '#607D8B'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
            
            // 情绪趋势图表
            const trendCtx = document.getElementById('emotionTrendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [
                        {
                            label: '开心',
                            data: Array.from({length: 24}, () => Math.floor(Math.random() * 20) + 5),
                            borderColor: '#4CAF50',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: '悲伤',
                            data: Array.from({length: 24}, () => Math.floor(Math.random() * 15) + 3),
                            borderColor: '#2196F3',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: '愤怒',
                            data: Array.from({length: 24}, () => Math.floor(Math.random() * 10) + 2),
                            borderColor: '#F44336',
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // 初始化环形情感模型图表
            initCircumplexChart();
            
            // 初始化三维情感模型图表
            initDimension3dChart();
        }
        
        // 初始化环形情感模型图表
        function initCircumplexChart() {
            const ctx = document.getElementById('circumplexChart').getContext('2d');
            
            // 初始化环形情感模型的散点图
            circumplexChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '情绪点',
                            data: [{ x: 0, y: 0 }],
                            backgroundColor: '#667eea',
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            radius: 10
                        },
                        {
                            label: '开心',
                            data: [{ x: 0.8, y: 0.7 }],
                            backgroundColor: '#4CAF50',
                            radius: 5
                        },
                        {
                            label: '悲伤',
                            data: [{ x: -0.6, y: -0.4 }],
                            backgroundColor: '#2196F3',
                            radius: 5
                        },
                        {
                            label: '愤怒',
                            data: [{ x: -0.7, y: 0.6 }],
                            backgroundColor: '#F44336',
                            radius: 5
                        },
                        {
                            label: '恐惧',
                            data: [{ x: -0.5, y: 0.8 }],
                            backgroundColor: '#FF9800',
                            radius: 5
                        },
                        {
                            label: '惊讶',
                            data: [{ x: 0.5, y: 0.9 }],
                            backgroundColor: '#9C27B0',
                            radius: 5
                        },
                        {
                            label: '厌恶',
                            data: [{ x: -0.8, y: 0.3 }],
                            backgroundColor: '#795548',
                            radius: 5
                        },
                        {
                            label: '中性',
                            data: [{ x: 0, y: 0 }],
                            backgroundColor: '#607D8B',
                            radius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '效价'
                            },
                            min: -1,
                            max: 1
                        },
                        y: {
                            title: {
                                display: true,
                                text: '唤醒度'
                            },
                            min: -1,
                            max: 1
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // 初始化三维情感模型图表
        function initDimension3dChart() {
            const ctx = document.getElementById('dimension3dChart').getContext('2d');
            
            // 由于Canvas 2D的限制，我们使用散点图模拟三维效果
            dimension3dChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '情绪点',
                            data: [{ x: 0, y: 0 }],
                            backgroundColor: '#667eea',
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            radius: 10
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '愉悦度'
                            },
                            min: -1,
                            max: 1
                        },
                        y: {
                            title: {
                                display: true,
                                text: '强度'
                            },
                            min: -1,
                            max: 1
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // 更新环形情感模型图表
        function updateCircumplexChart(valence, arousal) {
            if (!circumplexChart) return;
            
            circumplexChart.data.datasets[0].data = [{ x: valence, y: arousal }];
            circumplexChart.update();
            
            document.getElementById('valenceValue').textContent = valence.toFixed(2);
            document.getElementById('arousalValue').textContent = arousal.toFixed(2);
        }
        
        // 更新三维情感模型图表
        function updateDimension3dChart(pleasure, intensity, attention) {
            if (!dimension3dChart) return;
            
            // 在2D散点图中，我们使用x轴表示愉悦度，y轴表示强度，使用不同的颜色或大小表示关注度
            dimension3dChart.data.datasets[0].data = [{ x: pleasure, y: intensity }];
            dimension3dChart.update();
            
            document.getElementById('pleasureValue').textContent = pleasure.toFixed(2);
            document.getElementById('intensityValue').textContent = intensity.toFixed(2);
            document.getElementById('attentionValue').textContent = attention.toFixed(2);
        }
        
        // 初始化实时检测功能
        function initRealTimeDetection() {
            const startBtn = document.getElementById('startDetection');
            const stopBtn = document.getElementById('stopDetection');
            
            startBtn.addEventListener('click', startRealTimeDetection);
            stopBtn.addEventListener('click', stopRealTimeDetection);
        }
        
        // 开始实时检测
        async function startRealTimeDetection() {
            if (isDetectionRunning) return;
            
            try {
                // 加载模型
                console.log('正在加载模型...');
                await loadFaceModels();
                console.log('模型加载成功');
                
                // 获取摄像头权限
                const video = document.querySelector('#detectionVideo');
                console.log('正在获取摄像头权限...');
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 }, // 降低分辨率，提高检测速度
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                console.log('摄像头权限获取成功');
                
                video.srcObject = videoStream;
                
                // 监听视频加载完成事件
                video.onloadedmetadata = function() {
                    console.log('视频元数据加载完成，尺寸:', video.videoWidth, 'x', video.videoHeight);
                    
                    // 初始化画布
                    const canvas = document.getElementById('detectionCanvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    console.log('画布初始化完成');
                    
                    // 开始检测
                    isDetectionRunning = true;
                    startDetectionLoop(video, canvas);
                    
                    document.getElementById('startDetection').disabled = true;
                    document.getElementById('stopDetection').disabled = false;
                };
            } catch (error) {
                console.error('启动检测失败:', error);
                alert('启动检测失败: ' + error.message);
            }
        }
        
        // 停止实时检测
        function stopRealTimeDetection() {
            if (!isDetectionRunning) return;
            
            isDetectionRunning = false;
            
            // 停止检测循环
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            
            // 停止视频流
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            // 清空画布
            const canvas = document.getElementById('detectionCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 更新UI
            document.getElementById('startDetection').disabled = false;
            document.getElementById('stopDetection').disabled = true;
            document.getElementById('currentEmotion').textContent = '未检测到人脸';
            document.getElementById('emotionConfidence').textContent = '置信度: -';
        }
        
        // 加载人脸模型
        async function loadFaceModels() {
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/';
            
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
            ]);
        }
        
        // 检测循环
        function startDetectionLoop(video, canvas) {
            const ctx = canvas.getContext('2d');
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // 设置临时画布大小
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            
            // 配置检测参数，提高检测成功率
            const faceDetectorOptions = new faceapi.TinyFaceDetectorOptions({
                inputSize: 224, // 降低输入尺寸，提高检测速度
                scoreThreshold: 0.5 // 降低置信度阈值，提高检测灵敏度
            });
            
            console.log('开始检测循环，视频尺寸:', video.videoWidth, 'x', video.videoHeight);
            
            detectionInterval = setInterval(async () => {
                if (!isDetectionRunning) return;
                
                try {
                    // 绘制视频帧到临时画布
                    tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
                    
                    // 应用图像增强
                    applyImageEnhancement(tempCanvas, tempCtx);
                    
                    // 检测人脸和表情
                    const detections = await faceapi
                        .detectAllFaces(tempCanvas, faceDetectorOptions)
                        .withFaceExpressions();
                    
                    console.log('检测结果:', detections.length, '个人脸');
                    
                    // 清空画布
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    if (detections.length > 0) {
                        // 绘制检测结果
                        const resizedDetections = faceapi.resizeResults(detections, {
                            width: video.videoWidth,
                            height: video.videoHeight
                        });
                        
                        faceapi.draw.drawDetections(canvas, resizedDetections);
                        
                        // 获取主要表情
                        const detection = detections[0];
                        const expressions = detection.expressions;
                        
                        // 找出置信度最高的表情
                        let maxEmotion = 'neutral';
                        let maxConfidence = 0;
                        
                        for (const [emotion, confidence] of Object.entries(expressions)) {
                            if (confidence > maxConfidence) {
                                maxEmotion = emotion;
                                maxConfidence = confidence;
                            }
                        }
                        
                        // 更新UI
                        document.getElementById('currentEmotion').textContent = emotionNames[maxEmotion];
                        document.getElementById('emotionConfidence').textContent = 
                            `置信度: ${(maxConfidence * 100).toFixed(1)}%`;
                        
                        // 保存识别记录
                        saveRecognitionRecord(expressions);
                        
                    } else {
                        document.getElementById('currentEmotion').textContent = '未检测到人脸';
                        document.getElementById('emotionConfidence').textContent = '置信度: -';
                    }
                } catch (error) {
                    console.error('检测过程出错:', error);
                }
            }, 100);
        }
        
        // 应用图像增强
        function applyImageEnhancement(canvas, ctx) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // 使用更保守的图像增强参数，避免影响人脸检测
            // 降低对比度和噪声去除强度
            const brightness = systemConfig.brightness;
            const contrast = Math.min(systemConfig.contrast, 1.3); // 限制对比度最大值
            const noiseReduction = Math.min(systemConfig.noiseReduction, 2); // 限制模糊半径最大值
            
            // 1. 亮度和对比度调整 - 更保守的调整
            for (let i = 0; i < data.length; i += 4) {
                // 调整亮度和对比度，使用更温和的公式
                data[i] = Math.min(255, Math.max(0, (data[i] - 128) * contrast + 128 * brightness));   // R
                data[i+1] = Math.min(255, Math.max(0, (data[i+1] - 128) * contrast + 128 * brightness)); // G
                data[i+2] = Math.min(255, Math.max(0, (data[i+2] - 128) * contrast + 128 * brightness)); // B
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            // 2. 噪声去除（高斯模糊）- 仅在必要时使用
            if (noiseReduction > 0) {
                applyGaussianBlur(canvas, ctx, noiseReduction);
            }
        }
        
        // 高斯模糊
        function applyGaussianBlur(canvas, ctx, radius) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const tempData = new Uint8ClampedArray(data.length);
            
            // 简单的高斯模糊实现
            const kernelSize = radius * 2 + 1;
            const sigma = radius / 3;
            const kernel = new Array(kernelSize);
            let sum = 0;
            
            // 计算高斯核
            for (let i = 0; i < kernelSize; i++) {
                const x = i - radius;
                kernel[i] = Math.exp(-(x * x) / (2 * sigma * sigma)) / (Math.sqrt(2 * Math.PI) * sigma);
                sum += kernel[i];
            }
            
            // 归一化
            for (let i = 0; i < kernelSize; i++) {
                kernel[i] /= sum;
            }
            
            // 水平模糊
            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    let r = 0, g = 0, b = 0;
                    for (let i = -radius; i <= radius; i++) {
                        const px = Math.min(canvas.width - 1, Math.max(0, x + i));
                        const idx = (y * canvas.width + px) * 4;
                        const weight = kernel[i + radius];
                        r += data[idx] * weight;
                        g += data[idx + 1] * weight;
                        b += data[idx + 2] * weight;
                    }
                    const idx = (y * canvas.width + x) * 4;
                    tempData[idx] = r;
                    tempData[idx + 1] = g;
                    tempData[idx + 2] = b;
                    tempData[idx + 3] = data[idx + 3]; // 保留透明度
                }
            }
            
            // 垂直模糊
            for (let x = 0; x < canvas.width; x++) {
                for (let y = 0; y < canvas.height; y++) {
                    let r = 0, g = 0, b = 0;
                    for (let i = -radius; i <= radius; i++) {
                        const py = Math.min(canvas.height - 1, Math.max(0, y + i));
                        const idx = (py * canvas.width + x) * 4;
                        const weight = kernel[i + radius];
                        r += tempData[idx] * weight;
                        g += tempData[idx + 1] * weight;
                        b += tempData[idx + 2] * weight;
                    }
                    const idx = (y * canvas.width + x) * 4;
                    data[idx] = r;
                    data[idx + 1] = g;
                    data[idx + 2] = b;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        // 计算情绪的连续向量值
        function calculateContinuousEmotion(expressions) {
            let result = {
                discrete: 'neutral',
                confidence: 0
            };
            
            // 找出置信度最高的离散情绪
            let maxEmotion = 'neutral';
            let maxConfidence = 0;
            
            for (const [emotion, confidence] of Object.entries(expressions)) {
                if (confidence > maxConfidence) {
                    maxEmotion = emotion;
                    maxConfidence = confidence;
                }
            }
            
            result.discrete = maxEmotion;
            result.confidence = maxConfidence;
            
            // 计算环形情感模型的效价-唤醒度
            let totalWeight = 0;
            let weightedValence = 0;
            let weightedArousal = 0;
            
            Object.entries(expressions).forEach(([emotion, confidence]) => {
                const coords = expressionCoordinates[emotion];
                if (coords) {
                    weightedValence += coords.valence * confidence;
                    weightedArousal += coords.arousal * confidence;
                    totalWeight += confidence;
                }
            });
            
            if (totalWeight > 0) {
                result.valence = weightedValence / totalWeight;
                result.arousal = weightedArousal / totalWeight;
            } else {
                result.valence = 0;
                result.arousal = 0;
            }
            
            // 计算三维情感模型的愉悦度-强度-关注度
            let weightedPleasure = 0;
            let weightedIntensity = 0;
            let weightedAttention = 0;
            
            Object.entries(expressions).forEach(([emotion, confidence]) => {
                const coords = expression3DCoordinates[emotion];
                if (coords) {
                    weightedPleasure += coords.pleasure * confidence;
                    weightedIntensity += coords.intensity * confidence;
                    weightedAttention += coords.attention * confidence;
                }
            });
            
            if (totalWeight > 0) {
                result.pleasure = weightedPleasure / totalWeight;
                result.intensity = weightedIntensity / totalWeight;
                result.attention = weightedAttention / totalWeight;
            } else {
                result.pleasure = 0;
                result.intensity = 0;
                result.attention = 0;
            }
            
            return result;
        }
        
        // 保存识别记录
        function saveRecognitionRecord(expressions) {
            // 计算连续情绪数据
            const emotionData = calculateContinuousEmotion(expressions);
            
            const record = {
                timestamp: new Date(),
                ...emotionData
            };
            
            // 添加到历史记录
            emotionHistory.push(record);
            
            // 限制历史记录长度
            if (emotionHistory.length > systemConfig.maxHistoryLength) {
                emotionHistory.shift();
            }
            
            // 检测情绪突变
            detectEmotionChange(record);
            
            // 更新趋势图表
            updateEmotionTrend();
            
            // 更新连续情绪模型图表
            updateCircumplexChart(emotionData.valence, emotionData.arousal);
            updateDimension3dChart(emotionData.pleasure, emotionData.intensity, emotionData.attention);
            
            // 这里可以添加保存到本地存储或服务器的逻辑
            console.log(`识别记录: ${emotionNames[emotionData.discrete]} (${(emotionData.confidence * 100).toFixed(1)}%)`);
        }
        
        // 检测情绪突变
        function detectEmotionChange(currentRecord) {
            if (emotionHistory.length < 2) return;
            
            const previousRecord = emotionHistory[emotionHistory.length - 2];
            
            // 计算情绪变化幅度
            let changeMagnitude = 0;
            
            if (systemConfig.emotionModel === 'discrete') {
                // 离散模型：情绪类型变化则认为是突变
                if (previousRecord.discrete !== currentRecord.discrete) {
                    changeMagnitude = 1.0;
                }
            } else {
                // 连续模型：计算向量变化幅度
                if (systemConfig.emotionModel === 'circumplex') {
                    // 环形模型：计算效价-唤醒度的欧氏距离
                    const dx = currentRecord.valence - previousRecord.valence;
                    const dy = currentRecord.arousal - previousRecord.arousal;
                    changeMagnitude = Math.sqrt(dx * dx + dy * dy);
                } else {
                    // 三维模型：计算三维空间的欧氏距离
                    const dx = currentRecord.pleasure - previousRecord.pleasure;
                    const dy = currentRecord.intensity - previousRecord.intensity;
                    const dz = currentRecord.attention - previousRecord.attention;
                    changeMagnitude = Math.sqrt(dx * dx + dy * dy + dz * dz);
                }
            }
            
            // 检查是否超过突变阈值
            if (changeMagnitude >= systemConfig.emotionChangeThreshold) {
                const event = {
                    id: emotionEvents.length + 1,
                    timestamp: new Date(),
                    type: '情绪突变',
                    from: emotionNames[previousRecord.discrete],
                    to: emotionNames[currentRecord.discrete],
                    magnitude: changeMagnitude.toFixed(2),
                    status: '未处理'
                };
                
                emotionEvents.push(event);
                
                // 更新告警列表
                updateAlertsTable();
            }
        }
        
        // 更新情绪趋势图表
        function updateEmotionTrend() {
            // 这里可以实现情绪趋势图表的更新逻辑
            // 目前使用的是静态图表，实际实现中可以动态更新
            console.log('更新情绪趋势图表');
        }
        
        // 更新告警列表
        function updateAlertsTable() {
            const alertsBody = document.getElementById('alertsTableBody');
            
            // 清空现有告警
            alertsBody.innerHTML = '';
            
            // 添加所有告警
            emotionEvents.forEach(event => {
                const row = document.createElement('tr');
                const statusBadge = event.status === '已处理' ? 
                    '<span class="badge bg-success">已处理</span>' : 
                    '<span class="badge bg-warning">未处理</span>';
                
                row.innerHTML = `
                    <td>${event.id}</td>
                    <td>设备 1</td>
                    <td>${event.type}</td>
                    <td>${event.timestamp.toLocaleString()}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm">处理</button>
                    </td>
                `;
                
                alertsBody.appendChild(row);
            });
        }
        
        // 加载系统数据
        function loadSystemData() {
            // 模拟加载系统数据
            document.getElementById('onlineDevices').textContent = 1;
            document.getElementById('todayRecognition').textContent = 125;
            document.getElementById('todayAlerts').textContent = 3;
            document.getElementById('accuracy').textContent = '89.2%';
        }
        
        // 加载模拟数据
        function loadMockData() {
            // 加载历史记录
            loadMockHistory();
            
            // 加载设备列表
            loadMockDevices();
            
            // 加载告警列表
            loadMockAlerts();
            
            // 加载日志
            loadMockLogs();
        }
        
        // 加载模拟历史记录
        function loadMockHistory() {
            const historyBody = document.getElementById('historyTableBody');
            
            for (let i = 1; i <= 10; i++) {
                const emotion = emotions[Math.floor(Math.random() * emotions.length)];
                const confidence = (Math.random() * 0.3 + 0.7).toFixed(3);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i}</td>
                    <td>设备 1</td>
                    <td>${new Date().toLocaleString()}</td>
                    <td>${emotionNames[emotion]}</td>
                    <td>${(confidence * 100).toFixed(1)}%</td>
                    <td>
                        <button class="btn btn-primary btn-sm">查看</button>
                        <button class="btn btn-danger btn-sm">删除</button>
                    </td>
                `;
                
                historyBody.appendChild(row);
            }
        }
        
        // 加载模拟设备列表
        function loadMockDevices() {
            const deviceBody = document.getElementById('deviceTableBody');
            
            const devices = [
                { id: 1, name: 'USB摄像头', type: 'USB', ip: '192.168.1.100', status: '在线' },
                { id: 2, name: '网络摄像头', type: 'IP', ip: '192.168.1.101', status: '离线' }
            ];
            
            devices.forEach(device => {
                const row = document.createElement('tr');
                const statusBadge = device.status === '在线' ? 
                    '<span class="badge bg-success">在线</span>' : 
                    '<span class="badge bg-danger">离线</span>';
                
                row.innerHTML = `
                    <td>${device.id}</td>
                    <td>${device.name}</td>
                    <td>${device.type}</td>
                    <td>${device.ip}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm">编辑</button>
                        <button class="btn btn-danger btn-sm">删除</button>
                    </td>
                `;
                
                deviceBody.appendChild(row);
            });
        }
        
        // 加载模拟告警列表
        function loadMockAlerts() {
            const alertsBody = document.getElementById('alertsTableBody');
            
            for (let i = 1; i <= 5; i++) {
                const alertTypes = ['愤怒情绪', '恐惧情绪', '设备离线', '识别异常'];
                const alertType = alertTypes[Math.floor(Math.random() * alertTypes.length)];
                const status = Math.random() > 0.5 ? '已处理' : '未处理';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i}</td>
                    <td>设备 1</td>
                    <td>${alertType}</td>
                    <td>${new Date().toLocaleString()}</td>
                    <td><span class="badge ${status === '已处理' ? 'bg-success' : 'bg-warning'}">${status}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm">处理</button>
                    </td>
                `;
                
                alertsBody.appendChild(row);
            }
        }
        
        // 加载模拟日志
        function loadMockLogs() {
            const logsBody = document.getElementById('logsTableBody');
            
            const logTypes = ['系统', '操作', '错误', '警告'];
            const actions = ['登录系统', '开始检测', '停止检测', '修改配置', '添加设备'];
            
            for (let i = 1; i <= 10; i++) {
                const logType = logTypes[Math.floor(Math.random() * logTypes.length)];
                const action = actions[Math.floor(Math.random() * actions.length)];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date().toLocaleString()}</td>
                    <td>${logType}</td>
                    <td>admin</td>
                    <td>${action}</td>
                `;
                
                logsBody.appendChild(row);
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initApp);
        
        // 退出登录
        document.getElementById('logoutBtn').addEventListener('click', () => {
            // 停止检测
            if (isDetectionRunning) {
                stopRealTimeDetection();
            }
            
            // 显示登录页面
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
        });
    </script>
</body>
</html>